{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<link rel="icon" type="image/png" href="{% static 'images/Shine.png' %}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ================= RESET & VARIABLES ================= */
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Poppins',sans-serif;
}

:root{
    --sidebar:#0f334b;
    --primary:#2d8a63;
    --primary-dark:#256f57;
    --bg:#eef3f1;
    --card:#ffffff;

    --text:#1f2937;
    --text-muted:#6b7280;

    --radius-sm:10px;
    --radius-md:16px;
    --radius-lg:22px;

    --shadow-sm:0 4px 12px rgba(0,0,0,0.05);
    --shadow-md:0 10px 30px rgba(15, 14, 14, 0.06);
}

/* ================= BODY ================= */
body{
    display:flex;
    min-height:100vh;
    background:var(--bg);
    color:var(--text);
}

/* ================= SIDEBAR ================= */
.sidebar{
    width:260px;
    background:linear-gradient(180deg,#0f334b,#0b2638);
    color:white;
    position:fixed;
    height:100vh;
    display:flex;
    flex-direction:column;
}

.sidebar-brand{
    padding:30px;
    font-size:22px;
    font-weight:700;
    letter-spacing:.5px;
}

.nav-menu{
    list-style:none;
    flex:1;
}

.nav-item a{
    display:flex;
    align-items:center;
    gap:15px;
    padding:14px 30px;
    color:rgba(255,255,255,.85);
    text-decoration:none;
    transition:.25s ease;
    cursor:pointer;
}

.nav-item a:hover{
    background:rgba(255,255,255,.08);
    padding-left:36px;
}

.nav-item.active a{
    background:white;
    color:var(--sidebar);
    border-radius:40px 0 0 40px;
    margin-left:20px;
    font-weight:600;
    box-shadow:var(--shadow-sm);
}

.sidebar-footer{
    text-align:center;
    padding:20px;
    font-size:12px;
    opacity:.8;
}

/* ================= MAIN CONTENT ================= */
.main-content{
    margin-left:260px;
    padding:35px;
    width:100%;
}

/* ================= TOP BAR ================= */
.top-bar{
    background:white;
    padding:18px 25px;
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow-sm);
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:30px;
}

.user-info{
    display:flex;
    align-items:center;
    gap:10px;
}

.user-info img{
    width:38px;
    height:38px;
    border-radius:50%;
}

/* ================= SECTIONS ================= */
.content-section{
    display:none;
    animation:fade .3s ease;
}

.content-section.active{
    display:block;
}

@keyframes fade{
    from{opacity:0;transform:translateY(6px)}
    to{opacity:1}
}

/* ================= DASHBOARD CARDS ================= */
.stats-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    gap:25px;
}

.stat-card{
    background:var(--card);
    padding:25px;
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow-md);
    position:relative;
    transition:.25s ease;
}

.stat-card:hover{
    transform:translateY(-6px);
    box-shadow:0 20px 40px rgba(0,0,0,0.08);
}

.stat-card h4{
    font-size:13px;
    text-transform:uppercase;
    color:var(--text-muted);
    letter-spacing:.04em;
}

.stat-card .value{
    font-size:30px;
    font-weight:700;
    margin-top:5px;
}

.icon-circle{
    position:absolute;
    top:20px;
    right:20px;
    width:40px;
    height:40px;
    background:#eef6f2;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--sidebar);
}

/* ================= COMMON UI ================= */
.dashboard-section{
    background:var(--card);
    padding:30px;
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow-md);
}

.section-title{
    font-size:20px;
    font-weight:600;
    margin-bottom:25px;
    color:var(--sidebar);
}

/* ================= BUTTONS ================= */
.btn{
    padding:10px 20px;
    border-radius:999px;
    font-size:13px;
    font-weight:600;
    border:none;
    cursor:pointer;
    transition:.25s ease;
}

.btn-primary{
    background:red;
    color:white;
}

.btn-primary:hover{
    background:var(--primary-dark);
    transform:translateY(-1px);
}

.btn-secondary{
    background:#f3f4f6;
    color:#374151;
}

.btn-secondary:hover{
    background:#e5e7eb;
}

/* ================= FILTERS ================= */
.filters{
    background:white;
    padding:20px;
    border-radius:var(--radius-md);
    box-shadow:var(--shadow-sm);
    margin-bottom:25px;
}

.filters form{
    display:flex;
    gap:15px;
    flex-wrap:wrap;
}

.filters input,
.filter-select{
    padding:10px 15px;
    border-radius:var(--radius-sm);
    border:1px solid #ddd;
    font-size:14px;
}

/* ================= TABLE ================= */
.table-box{
    background:white;
    padding:25px;
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow-md);
}

table{
    width:100%;
    border-collapse:collapse;
}

th,td{
    padding:14px;
    text-align:left;
    border-bottom:1px solid #eee;
}

th{
    font-size:12px;
    text-transform:uppercase;
    color:var(--text-muted);
}

/* ================= STATUS BADGES ================= */
.status{
    padding:4px 12px;
    border-radius:999px;
    font-size:11px;
    font-weight:600;
}

.status-open{background:#e6f4ef;color:#2d8a63}
.status-closed{background:#fdecea;color:#e74c3c}
.status-approved{background:#e6f4ef;color:#2d8a63}
.status-pending{background:#fff4e5;color:#c47a12}
/* ================= MANAGE SHOPS ================= */

#shops .dashboard-section{
    background:var(--sidebar);
    padding:24px;
    border-radius:var(--radius-md);
    box-shadow:var(--shadow-sm);
}

/* ---------- GRID ---------- */
.shops-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Slightly wider cards look better */
    gap: 20px;
}

/* ---------- SHOP CARD ---------- */
.shop-card{
    background:#ffffff;
    border-radius:var(--radius-sm);
    padding:16px;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    border-left:3px solid white;
    transition:box-shadow .2s ease, transform .2s ease;
}

.shop-card:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 20px rgba(0,0,0,.08);
}

/* ---------- HEADER ---------- */
.shop-card h3{
    font-size:14px;
    font-weight:600;
    color:var(--sidebar);
    margin-bottom:6px;
}

/* ---------- DETAILS ---------- */
.shop-card p{
    font-size:12px;
    color:var(--sidebar);
    margin-bottom:4px;
    display:flex;
    align-items:center;
    gap:6px;
}

.shop-card p i{
    font-size:11px;
}

/* ---------- STATUS ---------- */
.shop-card .status {
    display: inline-flex;
    align-items: center;
    gap: 5px; /* Adds space between icon and text */
    padding: 4px 12px;
    font-size: 11px;
    letter-spacing: 0.3px;
}

/* State colors */
.status-open{
    background:#e6f4ef;
    color:#0f334b;
}

.status-closed{
    background:#fdecea;
    color:#0f334b;
}

.status-approved{
    background:#e6f4ef;
    color:#0f334b;
}

.status-pending-approval{
    background:#fff4e5;
    color:#a16207;
}

/* ---------- ACTIONS ---------- */
.shop-card .actions{
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #eef2f0;
    display:flex;
    gap:6px;
    flex-wrap:wrap;
}

/* ---------- BUTTONS ---------- */
.shop-card .btn{
    font-size:11px;
    padding:5px 12px;
    border-radius:999px;
    font-weight:600;
    line-height:1;
}

.shop-card .btn-primary{
    background:var(--primary);
    color:#ffffff;
}

.shop-card .btn-primary:hover{
    background:var(--primary-dark);
}

.shop-card .btn-secondary{
    background:#f3f4f6;
    color:#374151;
}

.shop-card .btn-secondary:hover{
    background:#e5e7eb;
}

/* ---------- EMPTY ---------- */
#shops .empty-state{
    text-align:center;
    padding:40px 20px;
    color:#9aa6a0;
}

#shops .empty-state i{
    font-size:34px;
    margin-bottom:8px;
    color:#cbd5cf;
}

.section-title{
    font-size:20px;
    font-weight:600;
    margin-bottom:25px;
    color:var(--sidebar);
}
.section-titles{
    font-size:20px;
    font-weight:600;
    margin-bottom:25px;
    color:white;
}
.dashboard-charts{
    margin-top:30px;
}

.dashboard-charts .range-toggle{
    display:flex;
    gap:8px;
    margin-bottom:16px;
}
/* ================= NOTIFICATIONS ================= */
.notification-wrapper {
    position: relative;
    cursor: pointer;
    margin-right: 20px;
}
.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ef4444;
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 50%;
    border: 2px solid white;
}
.notif-dropdown {
    position: absolute;
    top: 45px;
    right: 0;
    width: 300px;
    background: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    display: none;
    z-index: 1000;
    border: 1px solid #eee;
}
.notif-dropdown.active {
    display: block;
}
.notif-header {
    padding: 15px;
    border-bottom: 1px solid #eee;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
}
.notif-item {
    padding: 12px 15px;
    border-bottom: 1px solid #f9f9f9;
    display: flex;
    gap: 12px;
    transition: background 0.2s;
}
.notif-item:hover {
    background: #f8fafc;
}
.notif-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.notif-content p {
    font-size: 12px;
    color: var(--text);
    margin: 0;
}
.notif-content span {
    font-size: 10px;
    color: var(--text-muted);
}
/* Notification Specifics */
.notification-wrapper { position: relative; }
.notification-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ff4757;
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 50%;
    border: 2px solid white;
    animation: pulse-red 2s infinite;
}
@keyframes pulse-red {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
}
.notif-dropdown {
    position: absolute;
    top: 45px;
    right: 0;
    width: 320px;
    background: white;
    border-radius: var(--radius-md);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    display: none;
    z-index: 9999;
    overflow: hidden;
    border: 1px solid #eee;
}
.notif-dropdown.active { display: block; }
.notif-header {
    padding: 15px;
    background: #f8fafc;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
}
.btn-clear { background: none; border: none; color: var(--primary); font-size: 11px; cursor: pointer; }
.notif-item {
    padding: 15px;
    display: flex;
    gap: 15px;
    cursor: pointer;
    transition: 0.2s;
    border-bottom: 1px solid #f1f5f9;
}
.notif-item:hover { background: #f8fafc; }
.notif-icon {
    width: 40px; height: 40px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.notif-warning { background: #fff4e5; color: #a16207; }
.notif-danger { background: #fdecea; color: #e74c3c; }
.notif-text p { margin: 0; font-size: 12px; line-height: 1.4; }
.empty-notif { padding: 30px; text-align: center; color: var(--text-muted); }
.empty-notif i { font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5; }
.badge-dot {
    height: 8px;
    width: 8px;
    background-color: #ef4444;
    border-radius: 50%;
    display: inline-block;
    margin-left: 5px;
}
/* Notification Page Cards */
.notification-feed {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.notif-card {
    display: flex;
    align-items: center;
    padding: 20px;
    background: #fff;
    border-radius: var(--radius-md);
    border-left: 5px solid #ddd;
    box-shadow: var(--shadow-sm);
    transition: 0.3s;
    cursor: pointer;
}
.notif-card:hover {
    transform: translateX(5px);
    box-shadow: var(--shadow-md);
}
.notif-card.warning { border-left-color: #f59e0b; }
.notif-card.danger { border-left-color: #ef4444; }
.notif-card.info { border-left-color: #3b82f6; }

.notif-card-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-right: 20px;
}
.warning .notif-card-icon { background: #fff4e5; color: #a16207; }
.danger .notif-card-icon { background: #fdecea; color: #e74c3c; }
.info .notif-card-icon { background: #eff6ff; color: #1e40af; }

.notif-card-body { flex: 1; }
.notif-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}
.notif-card-header h4 { font-size: 16px; color: var(--sidebar); }
.notif-card-header span { font-size: 11px; font-weight: 700; text-transform: uppercase; opacity: 0.6; }
.notif-card-body p { font-size: 13px; color: var(--text-muted); }
.arrow { color: #ccc; margin-left: 15px; }
</style>
</head>

<body>

<!-- ================= SIDEBAR ================= -->
    <div class="sidebar">
        <div class="sidebar-brand">Bright & Shine</div>

        <ul class="nav-menu">
            <li class="nav-item active">
        <a onclick="showSection('dashboard', this.parentElement)">
            <i class="fas fa-th-large"></i> Dashboard
                </a>
            </li>

            <li class="nav-item">
                <a onclick="showSection('users', this.parentElement)">
                    <i class="fas fa-users"></i> Users
                </a>
            </li>

            <li class="nav-item">
                <a onclick="showSection('orders', this.parentElement)">
                    <i class="fas fa-list"></i> Orders
                </a>
            </li>

            <li class="nav-item">
                <a onclick="showSection('shops', this.parentElement)">
                    <i class="fas fa-store"></i> Shops
                </a>
            </li>
            <li class="nav-item">
                <a onclick="showSection('notifications-page', this.parentElement)">
                    <i class="fas fa-bell"></i> Notifications 
                    {% if show_notification_indicator %}
                        <span class="badge-dot"></span>
                    {% endif %}
                </a>
            </li>
            <li class="nav-item">
                <a href="{% url 'logout' %}">
                    <i class="fas fa-power-off"></i> Logout
                </a>
            </li>
        </ul>

        <div class="sidebar-footer">
            <i class="fas fa-headset"></i>
            <p>24/7 Support</p>
        </div>
    </div>

<!-- ================= MAIN ================= -->
    <div class="main-content">

        <div class="top-bar">
            <h3>Admin Panel</h3>
            <div style="display: flex; align-items: center; gap: 20px;">
                
                <div class="notification-wrapper" id="notifBtn">
                    <i class="fas fa-bell" style="font-size: 20px; color: var(--sidebar); cursor: pointer;"></i>
                    {% if show_notification_indicator %}
                        <span class="notification-badge">{{ pending_approvals|add:delayed_orders_count }}</span>
                    {% endif %}
                    <div class="notif-dropdown" id="notifDropdown">
                        <div class="notif-header">
                            <span>Recent Alerts</span>
                            <button class="btn-clear" onclick="clearNotifs()">Mark All Read</button>
                        </div>
                        <div class="notif-body">
                            {% if pending_approvals > 0 %}
                            <div class="notif-item" onclick="showSection('shops', document.querySelector('.nav-item i.fa-store').parentElement.parentElement)">
                                <div class="notif-icon notif-warning">
                                    <i class="fas fa-store"></i>
                                </div>
                                <div class="notif-text">
                                    <p><strong>{{ pending_approvals }} New Shop Requests</strong></p>
                                    <p>Action required: Approve or Reject new business registrations.</p>
                                </div>
                            </div>
                            {% endif %}

                            {% if delayed_orders_count > 0 %}
                            <div class="notif-item" onclick="showDelayedOrders()">
                                <div class="notif-icon notif-danger">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="notif-text">
                                    <p><strong>{{ delayed_orders_count }} Orders Delayed</strong></p>
                                    <p>Warning: These orders have passed their predicted delivery time.</p>
                                </div>
                            </div>
                            {% endif %}

                            {% if pending_approvals == 0 and delayed_orders_count == 0 %}
                            <div class="empty-notif">
                                <i class="fas fa-check-circle"></i>
                                <p>All caught up!</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name={{ request.user.username }}&background=0f334b&color=fff">
                    <strong>{{ request.user.username }}</strong>
                </div>
            </div>
        </div>
        <div id ="dashboard" class="content-section active">
            <div class="dashboard-section" style="margin-top:30px">
                <h3 class="section-title">
                    <i class="fas fa-chart-line"></i> Today at a Glance
                </h3>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Total Orders</h4>
                        <div class="value">{{ total_orders }}</div>
                        <div class="icon-circle"><i class="fas fa-shopping-bag"></i></div>
                    </div>

                    <div class="stat-card">
                        <h4>Total Revenue</h4>
                        <div class="value">₹{{ today_revenue|floatformat:2 }}</div>
                        <div class="icon-circle"><i class="fas fa-rupee-sign"></i></div>
                    </div>

                    <div class="stat-card">
                        <h4>Today Revenue</h4>
                        <div class="value">₹{{ today_revenue|floatformat:2 }}</div>
                        <div class="icon-circle"><i class="fas fa-calendar-day"></i></div>
                    </div>
                </div>
            </div>
        <!-- ================= CHARTS ================= -->
            <div class="dashboard-section dashboard-charts">
                <h3 class="section-title">
                    <i class="fas fa-chart-line"></i> Performance Overview
                </h3>
                <div style="display:flex;gap:8px;margin-bottom:15px">
                    <a href="?range=7{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                    class="btn btn-secondary {% if range_days == 7 %}btn-primary{% endif %}">
                        7 Days
                    </a>

                    <a href="?range=30"
                    class="btn btn-secondary {% if range_days == 30 %}btn-primary{% endif %}">
                        30 Days
                    </a>

                    <a href="?range=90"
                    class="btn btn-secondary {% if range_days == 90 %}btn-primary{% endif %}">
                        90 Days
                    </a>
                </div>
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">

                    <!-- Revenue Trend -->
                    <div class="table-box">
                        <h4 style="margin-bottom:10px;font-size:14px;color:#374151">
                            Revenue Trend
                        </h4>
                        <canvas id="revenueChart" height="120"></canvas>
                    </div>

                    <!-- Orders Per Day -->
                    <div class="table-box">
                        <h4 style="margin-bottom:10px;font-size:14px;color:#374151">
                            Orders Per Day
                        </h4>
                        <canvas id="ordersChart" height="120"></canvas>
                    </div>

                </div>
            </div>
        </div>
        <!-- ===== USER CONTROL ===== -->
        <div id="users" class="content-section">
            <div class="filters">
                <form id="userSearchForm">
                    <input type="text"
                        id="userSearchInput"
                        placeholder="Search by username, email, or name...">

                    <button type="submit" class="btn" style="background: var(--sidebar); color: white;">
                        <i class="fas fa-search"></i> Search
                    </button>

                    <button type="button"
                            class="btn btn-secondary"
                            onclick="loadAllUsers()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </form>
            </div>

            <div class="table-box">
                <h3 style="margin-bottom:15px">Manage Users</h3>

                <!-- THIS PART WILL BE UPDATED DYNAMICALLY -->
                <div id="usersTableWrapper">
                    {% include "admin/partials/users_table.html" %}
                </div>
            </div>
        </div>

        <div id="orders" class="content-section">

            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-list-alt"></i> All Orders
                    </h2>
                </div>

                <!-- Filters -->
                <div class="filters">
                    <form id="ordersFilterForm" style="display:flex; gap:15px; flex-wrap:wrap; width:100%;">
                        <input type="text" name="search" placeholder="Search by user, email, or order ID">

                        <select name="status" class="filter-select">
                            <option value="">All Status</option>
                            {% for code, label in status_choices %}
                                <option value="{{ code }}">{{ label }}</option>
                            {% endfor %}
                        </select>

                        <select name="delayed" class="filter-select" style="border: 1px solid #ef4444; color: #ef4444;">
                            <option value="">All Timeline</option>
                            <option value="1">Show Delayed Only</option>
                        </select>

                        <button type="submit" class="btn" style="background:var(--sidebar); color:white;">
                            <i class="fas fa-search"></i> Filter
                        </button>
                        </form>
                </div>
                <button id="backToAllOrdersBtn"
                        class="btn btn-secondary"
                        style="display:none; margin-bottom:15px;"
                        onclick="loadAllOrders()">
                    <i class="fas fa-arrow-left"></i> Back to All Orders
                </button>

                <!-- Orders Table -->
                <div class="table-box">
                    <div id="ordersTableWrapper">
                        {% include "admin/partials/orders_table.html" %}
                    </div>
                </div>
            </div>
        </div>
        <div id="notifications-page" class="content-section">
            <div class="dashboard-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 class="section-title" style="margin-bottom: 0;">
                        <i class="fas fa-bell"></i> Administrative Notifications
                    </h2>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh Feed
                    </button>
                </div>

                <div class="notification-feed">
                    {% if pending_approvals > 0 %}
                    <div class="notif-card warning" onclick="showSection('shops', document.querySelector('[onclick*=\'shops\']').parentElement)">
                        <div class="notif-card-icon">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="notif-card-body">
                            <div class="notif-card-header">
                                <h4>New Shop Registration</h4>
                                <span>Action Required</span>
                            </div>
                            <p>There are <strong>{{ pending_approvals }}</strong> shops waiting for your verification. Approval is required before they can list services.</p>
                        </div>
                        <i class="fas fa-chevron-right arrow"></i>
                    </div>
                    {% endif %}

                    {% if delayed_orders_count > 0 %}
                    <div class="notif-card danger" onclick="showDelayedOrders()">
                        <div class="notif-card-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="notif-card-body">
                            <div class="notif-card-header">
                                <h4>Order Delays Detected</h4>
                                <span>Urgent</span>
                            </div>
                            <p><strong>{{ delayed_orders_count }}</strong> orders have exceeded their predicted delivery time. Please check branch loads.</p>
                        </div>
                        <i class="fas fa-chevron-right arrow"></i>
                    </div>
                    {% endif %}

                    <div class="notif-card info">
                        <div class="notif-card-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="notif-card-body">
                            <div class="notif-card-header">
                                <h4>System Update</h4>
                                <span>Info</span>
                            </div>
                            <p>Welcome to the 2026 Admin Dashboard. All backup systems are currently operational.</p>
                        </div>
                    </div>

                    {% if pending_approvals == 0 and delayed_orders_count == 0 %}
                    <div class="empty-state">
                        <i class="fas fa-check-double"></i>
                        <p>No pending administrative actions. You're all caught up!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
            <!-- ===== ACCESS REQUEST ===== -->
        <div id="shops" class="content-section">
            <div class="dashboard-section">
                <h2 class="section-titles">
                    <i class="fas fa-store"></i> Manage Shops
                </h2>

                {% if shops %}
                <div class="shops-grid">
                    {% for shop in shops %}
                    <div class="shop-card">

                        <h3>{{ shop.name }}</h3>
                        <p><i class="fas fa-code-branch"></i> {{ shop.branches.count }} Branches</p>
                        <p><i class="fas fa-map-marker-alt"></i> {{ shop.address }}</p>
                        <p><i class="fas fa-phone"></i> {{ shop.phone }}</p>

                        <span class="status {% if shop.is_open %}status-open{% else %}status-closed{% endif %}">
                            {% if shop.is_open %}
                                <i class="fas fa-door-open"></i> Open
                            {% else %}
                                <i class="fas fa-door-closed"></i> Closed
                            {% endif %}
                        </span>

                        <div class="approval-status">
                            <span class="status {% if shop.is_approved %}status-approved{% else %}status-pending-approval{% endif %}">
                                {% if shop.is_approved %}
                                    <i class="fas fa-check"></i> Approved
                                {% else %}
                                    <i class="fas fa-clock"></i> Pending Approval
                                {% endif %}
                            </span>
                        </div>

                        <div class="actions">
                            {% if not shop.is_approved %}
                            <button onclick="approveShop({{ shop.id }})"
                                    class="btn btn-primary"
                                    style="font-size:12px">
                                <i class="fas fa-check"></i> Approve
                            </button>

                            <button onclick="rejectShop({{ shop.id }})"
                                    class="btn btn-secondary"
                                    style="font-size:12px">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            {% endif %}

                            <a href="{% url 'admin_edit_shop' shop.id %}"
                            class="btn btn-secondary"
                            style="font-size:12px">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                        </div>

                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-store"></i>
                    <p>No shops found</p>
                </div>
                {% endif %}

            </div>
        </div>
    </div>

    <script>
    // Toggle Dropdown
        document.getElementById('notifBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('notifDropdown').classList.toggle('active');
        });

        // Close when clicking elsewhere
        window.addEventListener('click', function() {
            document.getElementById('notifDropdown').classList.remove('active');
        });

        // Navigate and close dropdown
        function goToNotif(sectionId, navElement) {
            showSection(sectionId, navElement);
            document.getElementById('notifDropdown').classList.remove('active');
        }
        function showSection(id, el) {
            document.querySelectorAll('.content-section')
                .forEach(s => s.classList.remove('active'));

            const section = document.getElementById(id);
            if (section) section.classList.add('active');

            document.querySelectorAll('.nav-item')
                .forEach(n => n.classList.remove('active'));

            el.classList.add('active');

            // --- NEW: Clear notifications if entering the notification page ---
            if (id === 'notifications-page') {
                clearIndicators();
            }

            if (id === 'notifications-page' || id === 'shops') {
                clearIndicators();
            }
            // Fix Chart.js resize
            setTimeout(() => {
                if (window.Chart) {
                    Object.values(Chart.instances).forEach(chart => chart.resize());
                }
            }, 200);
        }

        function clearIndicators() {
            // 1. Hide them immediately on the screen
            const badge = document.querySelector('.notification-badge');
            const dot = document.querySelector('.badge-dot');
            if (badge) badge.style.display = 'none';
            if (dot) dot.style.display = 'none';

            // 2. Tell the Django Server to remember this for the refresh
            fetch('/admin-panel/mark-notifications-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            }).then(res => {
                console.log("Indicators cleared on server.");
            }).catch(err => console.error("Session update failed:", err));
        }


        // Update your goToNotif function to also clear indicators
        function goToNotif(sectionId, navElement) {
            showSection(sectionId, navElement);
            document.getElementById('notifDropdown').classList.remove('active');
            clearIndicators();
        }


        function showDelayedOrders() {
            // 1. Ensure the "Orders" tab is active
            const ordersNavItem = [...document.querySelectorAll(".nav-item")]
                .find(item => item.getAttribute("onclick")?.includes("orders"));
            showSection('orders', ordersNavItem);

            // 2. Fetch the filtered data
            fetch(`/admin-panel/orders/filter/?delayed=1`)
                .then(res => res.text())
                .then(html => {
                    document.getElementById("ordersTableWrapper").innerHTML = html;
                });
        }

        function loadAllOrders() {
            fetch(`/admin-panel/orders/filter/`)
                .then(res => res.text())
                .then(html => {
                    document.getElementById("ordersTableWrapper").innerHTML = html;
                });
        }

        const form = document.getElementById("userSearchForm");
        const input = document.getElementById("userSearchInput");
        const tableWrapper = document.getElementById("usersTableWrapper");

        form.addEventListener("submit", function (e) {
            e.preventDefault();

            fetch(`/dashboard/users/search/?q=${encodeURIComponent(input.value)}`)
                .then(response => response.text())
                .then(html => {
                    tableWrapper.innerHTML = html;
                })
                .catch(err => console.error(err));
        });

        function loadAllUsers() {
            input.value = "";
            fetch(`/dashboard/users/search/?q=`)
                .then(response => response.text())
                .then(html => {
                    tableWrapper.innerHTML = html;
                });
        }

        function approveShop(shopId) {
            if (!confirm("Approve this shop?")) return;

            fetch(`/admin-panel/shop/${shopId}/approve/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                },
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Shop approved successfully");
                    location.reload();
                } else {
                    alert(data.message || "Approval failed");
                }
            });
        }

        function rejectShop(shopId) {
            if (!confirm("Reject this shop?")) return;

            fetch(`/admin-panel/shop/${shopId}/reject/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                },
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Shop rejected successfully");
                    location.reload();
                } else {
                    alert(data.message || "Rejection failed");
                }
            });
        }

        const ordersForm = document.getElementById("ordersFilterForm");
        const ordersWrapper = document.getElementById("ordersTableWrapper");

        ordersForm.addEventListener("submit", function (e) {
            e.preventDefault(); // stop full page reload

            const formData = new FormData(ordersForm);
            const query = new URLSearchParams(formData).toString();

            fetch(`/admin-panel/orders/filter/?${query}`)
                .then(response => response.text())
                .then(html => {
                    ordersWrapper.innerHTML = html; // update orders table only
                })
                .catch(err => console.error("Orders filter error:", err));
        });

        function resetOrdersFilter() {
            ordersForm.reset();
            ordersForm.dispatchEvent(new Event("submit"));
        }
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                document.cookie.split(";").forEach(cookie => {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    }
                });
            }
            return cookieValue;
        }
        document.addEventListener("DOMContentLoaded", function () {

            const hash = window.location.hash;

            if (hash === "#shops") {

                // Find the sidebar item safely
                const shopsNavItem = [...document.querySelectorAll(".nav-item")]
                    .find(item => item.getAttribute("onclick")?.includes("shops"));

                if (shopsNavItem && typeof showSection === "function") {
                    showSection("shops", shopsNavItem);
                }
            }

        });

        /* ---------- Revenue Trend Chart ---------- */
        const revenueCtx = document.getElementById("revenueChart");

        if (revenueCtx) {
            const gradient = revenueCtx.getContext("2d").createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, "rgba(45,138,99,0.35)");
            gradient.addColorStop(1, "rgba(45,138,99,0.05)");

            new Chart(revenueCtx, {
                type: "line",
                data: {
                    labels: {{ chart_labels|safe }},
                    datasets: [{
                        data: {{ revenue_chart_data|safe }},
                        borderColor: "#2d8a63",
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.45,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: "#2d8a63",
                        pointBorderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: "#0f334b",
                            padding: 12,
                            callbacks: {
                                label: ctx => ` Revenue: ₹${ctx.raw}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: "#6b7280", font: { size: 11 } }
                        },
                        y: {
                            grid: { color: "#eef2f0" },
                            ticks: {
                                color: "#6b7280",
                                callback: v => "₹" + v
                            }
                        }
                    }
                }
            });
        }

        /* ---------- Orders Per Day Chart ---------- */
        const ordersCtx = document.getElementById("ordersChart");

        new Chart(ordersCtx, {
            type: "bar",
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [{
                    label: "Orders",
                    data: {{ orders_chart_data|safe }},
                    backgroundColor: "#0f334b",
                    borderRadius: 6,
                    maxBarThickness: 28
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: "#eef2f0" }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
        function toggleNotif() {
            const dropdown = document.getElementById('notifDropdown');
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.closest('.notification-wrapper')) {
                const dropdown = document.getElementById('notifDropdown');
                if (dropdown && dropdown.classList.contains('active')) {
                    dropdown.classList.remove('active');
                }
            }
        }
    </script>

</body>
</html>
